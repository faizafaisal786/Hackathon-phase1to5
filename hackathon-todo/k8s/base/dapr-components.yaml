# Dapr Components for Redpanda Cloud (Kafka-compatible)
# Redpanda Cloud offers a free tier: https://redpanda.com/pricing
---
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: taskpubsub
  namespace: hackathon-todo
spec:
  type: pubsub.kafka
  version: v1
  metadata:
    # Redpanda Cloud connection
    - name: brokers
      secretKeyRef:
        name: redpanda-credentials
        key: brokers
    - name: authType
      value: "password"
    - name: saslUsername
      secretKeyRef:
        name: redpanda-credentials
        key: username
    - name: saslPassword
      secretKeyRef:
        name: redpanda-credentials
        key: password
    - name: saslMechanism
      value: "SCRAM-SHA-256"
    - name: initialOffset
      value: "oldest"
    - name: consumerGroup
      value: "hackathon-todo"
    - name: clientID
      value: "hackathon-todo-backend"
    # TLS Configuration
    - name: disableTls
      value: "false"
---
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: statestore
  namespace: hackathon-todo
spec:
  type: state.redis
  version: v1
  metadata:
    - name: redisHost
      value: "redis.hackathon-todo.svc.cluster.local:6379"
    - name: redisPassword
      value: ""
    - name: actorStateStore
      value: "true"
    - name: keyPrefix
      value: "name"
---
# Redpanda credentials secret (to be populated via CI/CD)
apiVersion: v1
kind: Secret
metadata:
  name: redpanda-credentials
  namespace: hackathon-todo
type: Opaque
stringData:
  # Get these from Redpanda Cloud Console
  # Free tier: https://cloud.redpanda.com
  brokers: "${REDPANDA_BROKERS}"
  username: "${REDPANDA_USERNAME}"
  password: "${REDPANDA_PASSWORD}"
---
# Subscription for task events
apiVersion: dapr.io/v2alpha1
kind: Subscription
metadata:
  name: task-events-subscription
  namespace: hackathon-todo
spec:
  topic: task-events
  routes:
    default: /events/task
  pubsubname: taskpubsub
  deadLetterTopic: dead-letter-queue
