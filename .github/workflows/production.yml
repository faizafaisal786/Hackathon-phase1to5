name: üöÄ Production Deploy

# Trigger: git push origin main
on:
  push:
    branches: [main]

env:
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================
  # üß™ Step 1: Test Code
  # ============================================================
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Test Backend
        working-directory: ./hackathon-todo/backend
        run: |
          pip install -r requirements.txt
          python -c "from main import app; print('‚úÖ Backend OK')"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Test Frontend
        working-directory: ./hackathon-todo/frontend
        run: |
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: https://placeholder.railway.app

  # ============================================================
  # üåê Step 2: Deploy Frontend (Vercel - FREE)
  # ============================================================
  deploy-frontend:
    name: üåê Deploy Frontend
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./hackathon-todo/frontend
          vercel-args: '--prod'

      - name: Frontend URL
        run: |
          echo "‚úÖ Frontend deployed!"
          echo "üåê URL: ${{ steps.vercel.outputs.preview-url }}"

  # ============================================================
  # ‚öôÔ∏è Step 3: Deploy Backend (Railway - FREE)
  # ============================================================
  deploy-backend:
    name: ‚öôÔ∏è Deploy Backend
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy Backend
        run: |
          cd hackathon-todo/backend
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Deploy Reminder Service
        run: |
          cd hackathon-todo/reminder-service
          railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      - name: Backend Deployed
        run: echo "‚úÖ Backend + Reminder Service deployed!"

  # ============================================================
  # üì¢ Step 4: Deployment Complete
  # ============================================================
  notify:
    name: üì¢ Done
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Success
        run: |
          echo "============================================"
          echo "üéâ DEPLOYMENT COMPLETE!"
          echo "============================================"
          echo ""
          echo "üåê Frontend: https://hackathon-todo.vercel.app"
          echo "‚öôÔ∏è Backend:  https://hackathon-todo-backend.railway.app"
          echo ""
          echo "‚úÖ No localhost - Real Cloud Deployment!"
          echo "============================================"
